# Changelog

## v1.4.0

### 功能
1. 新增系统状态检查功能
   - 添加 `--status` 参数，提供全面的系统状态报告
   - 显示 ZeroTier 和 ztncui 安装状态及版本信息
   - 显示 Moon 节点支持状态和数量
   - 显示 Web UI 访问地址（HTTP/HTTPS）
   - 显示网络配置信息（网络ID、本机IP）
   - 显示下载服务状态（ON/OFF）及可用下载链接

2. 智能状态检测逻辑
   - 精确检测服务运行状态
   - 动态获取网络配置信息
   - 智能识别下载服务状态
   - 根据服务状态动态显示下载链接或本地路径

### 优化
1. 改进状态显示格式
   - 服务开启时显示完整的 HTTP 下载链接
   - 服务关闭时显示 `none` 表示无可用链接
   - 优化网络信息获取逻辑，避免显示乱码

2. 增强错误处理和容错性
   - 所有外部命令添加错误抑制
   - 提供备用获取方案（公网IP → 内网IP）
   - 多重验证确保状态信息准确性

### 修复
1. 修复网络配置显示问题
   - 问题：网络ID显示为 `<nwid>`，IP显示为 `<ZT`
   - 解决：优化 `zerotier-cli listnetworks` 输出解析逻辑
   - 改进：跳过表头行，精确匹配数据行格式

2. 修复下载链接显示逻辑
   - 问题：服务关闭时仍显示文件路径
   - 解决：服务关闭时统一显示 `none`
   - 改进：服务开启时显示完整下载链接

## v1.3.0

### 功能
1. 智能部署检测和跳过
   - 检测已完整部署的 ZeroTier 和 ztncui 组件
   - 自动跳过不必要的重复安装和配置
   - 支持 `--reinstall` 强制重装

2. 增强的 Moon 节点部署逻辑
   - 修复重装模式下文件路径检测问题
   - 验证现有文件有效性，避免保留无效配置
   - 使用 `find . -maxdepth 1` 避免在子目录中找到文件

3. 统一的服务管理
   - 添加 `restart_zerotier_service` 函数，支持重试机制
   - 改进服务重启后的状态验证
   - 统一在线和离线脚本的服务管理逻辑

### 优化
1. 改进错误处理和用户提示
   - ztncui 安装失败时检查 ZeroTier 服务状态
   - 提供更明确的错误信息和解决建议
   - 移除不必要的 `.env` 文件备份逻辑

2. 代码重构和清理
   - 移除主脚本中的重复文件复制逻辑
   - 让子脚本独立处理各自的文件管理
   - 统一 `copy_moon_to_download_dir` 函数实现

3. 智能依赖检查
   - 离线模式：提示用户手动安装缺失工具
   - 在线模式：自动安装必要依赖

### 修复
1. 修复 Moon 配置文件生成时的路径检测问题
   - 问题：`find` 命令在子目录中找到文件导致逻辑错误
   - 解决：限制搜索深度，只在当前目录查找

2. 修复重装模式下保留无效文件的问题
   - 问题：检测到网络ID相同时，可能保留无效的现有文件
   - 解决：验证现有文件有效性，无效时重新生成

3. 修复 ztncui 安装脚本中的重复逻辑
   - 移除冗余的 `copy_planet` 函数
   - 移除不必要的 `.env` 文件备份

## v1.2.0

### 功能
1. 智能 Moon 节点自动部署
   - 自动生成 moon.json 配置文件
   - 自动获取公网 IP 并添加到 stableEndpoints
   - 自动生成 .moon 文件并部署到 moons.d/
   - 自动创建默认 ZeroTier 网络 (10.24.0.0/24)
   - 自动加入网络并分配固定 IP (10.24.0.1/24)
   - 自动重启 ZeroTier 服务应用配置
   - 自动复制 .moon 文件到 planet-download/ 目录

2. 一键清理管理功能
   - `--clear zerotier`: 完全清理 ZeroTier 安装
   - `--clear ztncui`: 完全清理 ztncui 安装
   - `--clear`: 清理所有组件

### 优化
1. 统一代码风格规范
   - 标准化所有脚本的头部注释格式
   - 统一日志输出和错误处理风格
   - 规范化函数和变量命名约定

2. 自动安装 jq 工具到所有相关脚本

3. 优化 Moon 部署流程，提高自动化程度

### 修复
1. 修复 ztncui HTTPS 端口 3443 首次启动不监听的问题
   - 根本原因：systemd EnvironmentFile 配置在首次启动时未完全生效
   - 解决方案：动态修改 systemd 服务文件，确保环境变量正确加载

2. 修复 `--clear` 参数处理中的变量未绑定错误

3. 修复 Moon 节点部署中的网络状态检查逻辑

## v1.0.0

### 功能
1. 主管理脚本 `onlinker.sh`
   - 统一安装命令管理
   - 支持在线/离线安装模式
   - 集成 planet 文件下载服务

2. Planet 文件自动下载服务
   - 自动复制生成的 planet 文件到 planet-download/ 目录
   - 启动 Python HTTP 服务器 (端口 8888)
   - 支持 `--download on/off` 参数控制

### 优化
1. 完善项目文档
   - 大幅更新 README.md
   - 添加详细的功能说明和使用指南

## v0.1.0

### 功能
1. 项目基础架构搭建

2. ZeroTier 在线/离线安装脚本
   - 支持 Ubuntu 16.04 LTS 到 24.04 LTS
   - 支持 amd64 和 arm64 架构

3. ztncui 在线/离线安装脚本
   - 仅支持 amd64 架构

4. 离线安装包支持
   - ZeroTier 1.14.2 多版本多架构 deb 包
   - ztncui 0.8.14 amd64 deb 包
   - 支持 xenial, bionic, focal, jammy, noble 版本

## v0.0.1

### 功能
1. 项目初始化
2. 基础项目结构创建
3. 创建 README.md 文件